<html>
<head>
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.1.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Bangers" rel="stylesheet">
<script src="imagefilters.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
<style>
#footer-right {
  margin-top: -30px;
  text-align: right;
}

.container {
  font-family: 'Bangers', cursive;
}

#hypertranscript .strikethrough {
  text-decoration: line-through;
}

#hypertranscript .annotation, #hypertranscript .parannotation{
  opacity: 0.7;
}

#hypertranscript span.highlight {
  background-color: yellow !important;
}

#hypertranscript span.highlight.active {
  background-color: lightGreen !important;
}

#hypertranscript  header {
  font-size: 200%;
}

#hypertranscript a {
  cursor: pointer;
  color: #000;
}
/*
#hypertranscript .active ~ span {
  color: #999;
}

#hypertranscript p.active ~ p span {
  color: #999;
}
*/

#hypertranscript span.read {
  color: #000 !important;
}

#hypertranscript span.unread {
  color: #999 !important;
}

#hypertranscript span.search-match {
  background-color: pink !important;
}

#hypertranscript span.share-match {
  background-color: #66ffad !important;
}

#hypertranscript sub:before {
  content: '\231C';
}

#hypertranscript sub.highlight-duration:before {
  content: '\231D';
}

#hypertranscript h5 {
  font-size: 130%;
}

[data-m] {
  cursor: pointer;
}
</style>

</head>
<body>

  <div class="container">

    <div class="span12">
      <div>
        <h2>Transcript View</h2>
      </div>
    </div>

    <div class="span12">
      <div>
        <video id="video" controls crossorigin="anonymous" width="640">
        </video>
      </div>
    </div>

    <div class="span12">
      <h4>(click on words to navigate, select text to tweet)</h4>
      <h3><a id="comiclink" href="#">Jump to Comic View</a></h3>
      <div class="row">
        <div id="hypertranscript" style="padding-left:20px">
        </div>
      </div>
    </div>

  <hr>

  <footer>
    <p>&copy; 2017 <a href="https://github.com/badideafactory">Bad Idea Factory</a></p>
    <p id="footer-right"><a href="https://twitter.com/biffud" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @Biffud</a></p>
  </footer>
  </div>

</div>

<script>
const video = document.getElementById('video');
const params = location.search.split('/');
console.log(params);
const uid = params[0].slice(1);
const clipStart = params[1];
const clipEnd = params[2];
const clipCc5Start = parseInt(clipStart) + 5; // adding 5 secs to subs as they're usually delayed
const clipCc5End = parseInt(clipEnd) + 5;

document.getElementById('comiclink').setAttribute('href', 'comicview.html'+location.search);

const mp4Url = "https://api.contextubot.net/proxy?url=https%3A//archive.org/download/"+uid+"/"+uid+".mp4%3Ft%3D"+clipStart+"/"+clipEnd;

console.log(mp4Url);

const srtUrl = "https://api.contextubot.net/proxy?url=https%3A//archive.org/download/"+uid+"/"+uid+".cc5.srt%3Ft%3D"+clipCc5Start+"/"+clipCc5End;

console.log(srtUrl);

let subsObj = null;

let sceneSplits = [];
let textSplits = [];

fetch(srtUrl).then(function(response) {

  response.text().then(function(data) {
    let text = data.toString();
    document.getElementById('hypertranscript').innerHTML = srtToHypertranscript(data, 2800);
    hyperaudiolite.init("hypertranscript", "video", false);

    video.src = mp4Url;
  });
});

function srtToHypertranscript(data, ccdelay) {

  var i = 0,
    len = 0,
    idx = 0,
    lines,
    time,
    text,
    sub;

  var paraSplitTime = 0.1;

  // Simple function to convert HH:MM:SS,MMM or HH:MM:SS.MMM to SS.MMM
  // Assume valid, returns 0 on error

  var toSeconds = function(t_in) {
    var t = t_in.split(':');

    try {
      var s = t[2].split(',');

      // Just in case a . is decimal seperator
      if (s.length === 1) {
        s = t[2].split('.');
      }

      return (
        parseFloat(t[0], 10) * 3600 +
        parseFloat(t[1], 10) * 60 +
        parseFloat(s[0], 10) +
        parseFloat(s[1], 10) / 1000
      );
    } catch (e) {
      return 0;
    }
  };

  var outputString = '<article><header></header><section><header></header><p>';
  var lineBreaks = true;
  var paraPunct = true;
  var ltime = 0;
  var ltext;

  // Here is where the magic happens
  // Split on line breaks
  lines = data.split(/(?:\r\n|\r|\n)/gm);
  len = lines.length;

  for (i = 0; i < len; i++) {
    sub = {};
    text = [];

    sub.id = parseInt(lines[i++], 10);

    // Split on '-->' delimiter, trimming spaces as well

    try {
      time = lines[i++].split(/[\t ]*-->[\t ]*/);
    } catch (e) {
      alert('Warning. Possible issue on line ' + i + ": '" + lines[i] + "'.");
      break;
    }

    sub.start = toSeconds(time[0]);

    // So as to trim positioning information from end
    if (!time[1]) {
      alert('Warning. Issue on line ' + i + ": '" + lines[i] + "'.");
      return;
    }

    idx = time[1].indexOf(' ');
    if (idx !== -1) {
      time[1] = time[1].substr(0, idx);
    }
    sub.end = toSeconds(time[1]);

    // Build single line of text from multi-line subtitle in file
    while (i < len && lines[i]) {
      text.push(lines[i++]);
    }

    // Join into 1 line, SSA-style linebreaks
    // Strip out other SSA-style tags
    sub.text = text.join('\\N').replace(/\{(\\[\w]+\(?([\w\d]+,?)+\)?)+\}/gi, '');

    // Escape HTML entities
    sub.text = sub.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Unescape great than and less than when it makes a valid html tag of a supported style (font, b, u, s, i)
    // Modified version of regex from Phil Haack's blog: http://haacked.com/archive/2004/10/25/usingregularexpressionstomatchhtml.aspx
    // Later modified by kev: http://kevin.deldycke.com/2007/03/ultimate-regular-expression-for-html-tag-parsing-with-php/
    sub.text = sub.text.replace(
      /&lt;(\/?(font|b|u|i|s))((\s+(\w|\w[\w\-]*\w)(\s*=\s*(?:\".*?\"|'.*?'|[^'\">\s]+))?)+\s*|\s*)(\/?)&gt;/gi,
      '<$1$3$7>'
    );
    //sub.text = sub.text.replace( /\\N/gi, "<br />" );
    sub.text = sub.text.replace(/\\N/gi, ' ');

    var splitMode = 0;

    var wordLengthSplit = true;

    // enhancements to take account of word length

    var swords = sub.text.split(' ');
    var sduration = sub.end - sub.start;
    var stimeStep = sduration / swords.length;

    // determine length of words

    var swordLengths = [];
    var swordTimes = [];

    var totalLetters = 0;
    for (var si = 0, sl = swords.length; si < sl; ++si) {
      totalLetters = totalLetters + swords[si].length;
      swordLengths[si] = swords[si].length;
    }

    var letterTime = sduration / totalLetters;
    var wordStart = 0;

    for (var si = 0, sl = swords.length; si < sl; ++si) {
      var wordTime = swordLengths[si] * letterTime;
      var stime;
      if (wordLengthSplit) {
        stime = Math.round((sub.start + si * stimeStep) * 1000);
        var event = new CustomEvent('ga', {
          detail: { origin: 'HA-Converter', type: 'Setting', action: 'Word length split ON' }
        });
        document.dispatchEvent(event);
      } else {
        stime = Math.round((wordStart + sub.start) * 1000);
        var event = new CustomEvent('ga', {
          detail: { origin: 'HA-Converter', type: 'Setting', action: 'Word length split OFF' }
        });
        document.dispatchEvent(event);
      }

      wordStart = wordStart + wordTime;
      var stext = swords[si];
      //var ssafeText = stext.replace('"', '\\"');
      //outputString += '<span m="'+stime+'" oval="'+ssafeText+'">'+stext+'</span> '+'\n';

      /*console.log("stime");
      console.log(stime);
      console.log("ltime");
      console.log(ltime);
      console.log("diff");
      console.log(stime - ltime);
      console.log(ltext);*/

      if (stime - ltime > paraSplitTime * 1000 && paraSplitTime > 0) {
        //console.log("fullstop? "+stext+" - "+stext.indexOf("."));
        var punctPresent =
          ltext && (ltext.indexOf('.') > 0 || ltext.indexOf('?') > 0 || ltext.indexOf('!') > 0);
        if (!paraPunct || (paraPunct && punctPresent)) {
          outputString += '</p><p>';
        }
      }

      outputString += '<span data-m="' + (stime + ccdelay) +'">' + stext + ' </span>';

      ltime = stime;
      ltext = stext;

      if (lineBreaks) outputString = outputString + '\n';
    }
  }
  return outputString + '</p><footer></footer></section></footer></footer></article>';
}
</script>
<script src="hyperaudio-lite.js"></script>
<script src="hyperaudio-lite-wrapper.js"></script>
<script src="https://hyperaudio.github.io/sharect/sharect.min.js"></script>

<script>
var sharect = new Sharect();
  sharect.config({
    /*facebook: true,*/
    twitter: true,
    twitterUsername: '%23hashtag', /*hashtag example*/
    /*backgroundColor: '#ff4081',*/
    iconColor: '#fff'
  }).init();
</script>
</body>
</html>
